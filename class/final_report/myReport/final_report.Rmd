---
title: "GIScience class final report"
author: "星澤 知宙"
date: "2022年6月30日"
output:
  html_document:
    df_print: paged
    theme: flatly
    toc: yes
    toc_float: true
  github_document:
    toc: yes
subtitle: "北海道における年ごとの観光入込客数に関する分析"
fontsize: 11pt
linestretch: 1.2
link-citations: yes
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r lib-in}
library(sf)
library(raster)
library(dplyr)
library(spData)
library(spDataLarge)
library(tmap)    # for static and interactive maps
library(leaflet) # for interactive maps
library(ggplot2) # tidyverse data visualization package
install.packages("openxlsx")
library(openxlsx)
install.packages("gifski")
library(gifski)
```

```{r functionSet}
# データの読み込みと整形. a=0:合計 a=1:対前年比
loadData <- function(year, a){
  data = read.xlsx(paste0("../data/", as.character(year), ".xlsx"))
  data = data %>% filter(区.分 == "入込総数") %>% filter(!is.na(市町村名))
  if(a==0){
    if(year < 2010)
      col_name = "年間合計"
    else
      col_name = "合計"
    data = data %>% select(市町村名, all_of(col_name))
    numbers = as.numeric(unlist(data[col_name])) * 1000
    if(year == 2021) # 2021年は4~9月のみのため倍にしている
      numbers = numbers*2
  }else{
    col_name = "対前年比"
    data = data %>% select(市町村名, all_of(col_name))
    numbers = as.numeric(unlist(data[col_name]))
    if(year==2010) # 2010年のみ表記が違う
      numbers = numbers*100
  }  
  data["num"] = numbers
  data = data %>%
    select(市町村名, num)
}
```

```{r loadData_and_makeMap}
# gifの作成

hkd_map = st_read("../data/hokkaido_map_4612.geojson")
hkd_map = hkd_map[1]

# 入込客数の合計
for(i in 0:21){
  data = loadData(i+2000, 0)
  map_data = left_join(data, hkd_map, by="市町村名")
  year = array(i+2000, c(nrow(map_data)))
  map_data["year"] = year
  if(i == 0)
    fin_data = map_data
  else
    fin_data = rbind(fin_data, map_data)
}
fin_data = st_as_sf(fin_data)
tmap_mode("plot")
anim_map = tm_shape(fin_data) + tm_borders() + 
  tm_text("市町村名", size=0.2) + tm_fill("num", style="cont") +
  tm_facets(along = "year", free.coords = FALSE)
tmap_animation(anim_map, filename = "./figures/anim_map_sum.gif", delay = 60)


# 入込客数の対前年比
for(i in 0:21){
  data = loadData(i+2000, 1)
  map_data = left_join(data, hkd_map, by="市町村名")
  year = array(i+2000, c(nrow(map_data)))
  map_data["year"] = year
  if(i == 0)
    fin_data = map_data
  else
    fin_data = rbind(fin_data, map_data)
}
fin_data = st_as_sf(fin_data)
tmap_mode("plot")
breaks = c(50, 75, 100, 125, 150)
anim_map = tm_shape(fin_data) + tm_borders() + 
  tm_text("市町村名", size=0.2) + tm_fill("num", style="cont", breaks=breaks) +
  tm_facets(along = "year", free.coords = FALSE)
tmap_animation(anim_map, filename = "./figures/anim_map_rat.gif", delay = 60)
```

```{r sum_gif}
knitr::include_graphics("figures/anim_map_sum.gif")
```

```

## 0. 要旨
AAAAAAAAAAAAAAAA. 
BBBBBBBBBBBBBBBB. 
CCCCCCCCCCCCCCC.   



<br>
<br>
  
  下のフォーマットは一例です。　
レポートの構成は多少替えても大丈夫です。

## 1. はじめに
### 1.1 背景
XXXXXXXX。 
Toblerは... [@tobler1970computer]。
aa [@tourists_data]
bb [@map_data]
XXXXXXXXXXXX。  

### 1.2 目的
XXXXXXXX。   

## 2. 手法
XXXXXXXX。
XXXXXXXXXXXX。  

## 3. データ
XXXXXXXX。
XXXXXXXXXXXX。  

## 4. 結果
XXXXXXXX。
XXXXXXXXXXXX。  

## 5. 考察
XXXXXXXX。
XXXXXXXXXXXX。  

## 6. 結論
XXXXXXXX。
XXXXXXXXXXXX。  

## 7. Graphic Abstract
レポートを表す１枚の図をここで示す。

## 8. 参考文献